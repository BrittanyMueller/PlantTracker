
stages:
  - lint
  - build
  - test
    
.base_job:
  image: registry.larrycloud.ca/qawse3dr/plant-tracker:latest 

Lint:
  extends: .base_job
  stage: lint
  script:
    - mkdir build
    - cd build
    - cmake ..
    - make test-format
  allow_failure: true
  
#########################################
#                                       #
#       PLANT TRACKER SERVER            #
#                                       #
#########################################
Build Plant Tracker Server:
  extends: .base_job
  stage: build
  script:
    - cd server
    - chmod +x ./gradlew
    - ./gradlew jar
    - mkdir -p ../out
    - mv app/build/libs/plant-tracker.jar ../out
  artifacts:
    paths:
      - out/
    expire_in: 1 week

Test Plant Tracker Server:
  extends: .base_job
  stage: test
  script:
    - cd server
    - chmod +x gradlew
    - ./gradlew test

# TODO will need to make my own build container to support building for RPI
# Build Plant Listener:
#   image: gcc 
#   extends: .base_job
#   stage: build
#   script:
#     - echo "TODO"


#########################################
#                                       #
#           PLANT LISTENER              #
#                                       #
#########################################
Build Plant Listener Tests:
  extends: .base_job
  stage: build
  artifacts:
    paths:
      - build
    expire_in: 1 week
  script:
    - mkdir build
    - cd build
    - cmake .. -DCMAKE_BUILD_TYPE=test
    - make -j4

Build Plant Listener Release:
  extends: .base_job
  stage: build
  artifacts:
    paths:
      - build
    expire_in: 1 week
  script:
    - mkdir build
    - cd build
    - cmake .. -DCMAKE_BUILD_TYPE=release
    - make -j4


Test Coverage Plant Listener:
  extends: .base_job
  stage: test
  dependencies:
    - Build Plant Listener Tests
  artifacts:
    paths:
      - out/
    reports:
      coverage_report:
        coverage_format: cobertura
        path: out/coverage.xml
  script:
    - cd build
    - ctest --output-on-failure
    - make plantlistener_coverage
    - cd ..
    - mkdir out
    - mv build/coverage out/coverage
    - mv build/coverage.xml out/coverage.xml

#########################################
#                                       #
#        PLANT TRACKER ANDROID          #
#                                       #
#########################################
Build Android Plant Tracker Debug:
  image: registry.larrycloud.ca/qawse3dr/plant-tracker-android:latest
  stage: build
  variables:
    BUILD_PLANT_LISTENER: 0
  script:
    - mkdir -p build
    - cd build
    - cmake ..
    - make PlantTracker
  artifacts:
    paths:
      - build/app
    expire_in: 1 week
